@model GenerateurDFUSafir.Models.GestionOp
@using GenerateurDFUSafir.Models
@{
    ViewBag.Title = "GestionOp";
    <link rel="stylesheet" href="~/Content/GestionOp.css">
}
<body>
    <div id="bandeau">
        <p id="titre">Gestion opérateurs</p>
        @using (Html.BeginForm("listespe", "Generique", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            <div id="FiltreService">
                <p>Trier par :</p>
                <select name="FiltreSaisieService" id="FiltreSaisieService" onchange="submit()">
                    @foreach (var item in Model.Service)
                    {
                        switch (item)
                        {
                            case "---":
                                if (Model.ServiceSelectionne.Contains("ALL"))
                                {
                                    <option value="ALL" id="ServiceAll" selected>@item</option>
                                }
                                else
                                {
                                    <option value="ALL" id="ServiceAll">@item</option>
                                }
                                break;
                            case "Production":
                                if (Model.ServiceSelectionne.Contains("PROD"))
                                {
                                    <option value="PROD" id="ServiceProd" selected>@item</option>
                                }
                                else
                                {
                                    <option value="PROD" id="ServiceProd">@item</option>
                                }
                                break;
                            case "R&D":
                                if (Model.ServiceSelectionne.Contains("RD"))
                                {
                                    <option value="RD" id="ServiceRD" selected>@item</option>
                                }
                                else
                                {
                                    <option value="RD" id="ServiceRD">@item</option>
                                }
                                break;
                            case "STC":
                                if (Model.ServiceSelectionne.Contains("STC"))
                                {
                                    <option value="STC" selected>@item</option>
                                }
                                else
                                {
                                    <option value="STC">@item</option>
                                }
                                break;
                            case "TCS":
                                if (Model.ServiceSelectionne.Contains("TCS"))
                                {
                                    <option value="TCS" selected>@item</option>
                                }
                                else
                                {
                                    <option value="TCS">@item</option>
                                }
                                break;
                            case "Marketing":
                                if (Model.ServiceSelectionne.Contains("MKT"))
                                {
                                    <option value="MKT" selected>@item</option>
                                }
                                else
                                {
                                    <option value="MKT">@item</option>
                                }
                                break;
                        }
                    }
                </select>
                <button id="btn-add" type="button" onclick="ouvrirPopupCreation()">Ajouter opérateur</button>
            </div>
        }
    </div>
    <hr />
    <div id="corps-liste">
        @foreach (var operateur in Model.Operateurs)
        {
            <div class="ligneOp" onclick='ouvrirPopupModification({
            id: @operateur.ID,
            nom: "@operateur.NOM",
            prenom: "@operateur.PRENOM",
            contrat: "@(operateur.FINCONTRAT?.ToString("yyyy-MM-dd") ?? "")",
            service: "@operateur.SERVICE",
            sousService: "@operateur.SousService",
            animateur: @(operateur.ANIMATEUR.ToString().ToLower()),
            isAdmin: @(operateur.isAdmin.ToString().ToLower()),
            photo: "@(string.IsNullOrWhiteSpace(operateur.PATHB) ? Url.Content("~/operateurs/OperateursA/default.bmp") : Url.Content("~/operateurs/OperateursA/" + System.IO.Path.GetFileName(operateur.PATHB)))"
        })'>



                <div id="op-pdp">
                    <img id="pp" src="@(string.IsNullOrWhiteSpace(operateur.PATHB) ? Url.Content("~/operateurs/OperateursA/default.bmp") :
                     Url.Content("~/operateurs/OperateursA/" + System.IO.Path.GetFileName(operateur.PATHB)))" alt="Photo profil" />
                </div>

                <div id="op-nom">
                    <p id="nom" class="text">@operateur.NOM</p>
                    <p id="prenom" class="text">@operateur.PRENOM</p>
                </div>

                <div id="op-contrat">
                    @{
                        string contratAffiche = "CDI";
                        if (operateur.FINCONTRAT != null)
                        {
                            string dateFinContratComplete = operateur.FINCONTRAT.ToString();
                            string dateFinContrat = dateFinContratComplete.Substring(0, 10);
                            contratAffiche = dateFinContrat;
                        }
                    }
                    <p id="date-contrat">@contratAffiche</p>
                </div>

                <div id="op-bouton">
                    <img src="~/image/redirection.png" alt="Aller à la fiche opérateur" />
                </div>

            </div>
        }
    </div>

    <div id="popup-modifier-operateur" class="popup" style="display: none;">
        <h3>Modifier Opérateur</h3>
        <form id="form-operateur" action="@Url.Action("ModifierOperateur", "Operateur")" method="post" enctype="multipart/form-data">
            <div id="ctn-form">
                <input type="hidden" name="IdOperateur" id="modif-id-operateur" />
                <div class="form-grid">
                    <div>
                        <label>Nom</label>
                        <input type="text" name="Nom" id="modif-nom" required />
                    </div>
                    <div>
                        <label>Prénom</label>
                        <input type="text" name="Prenom" id="modif-prenom" required />
                    </div>

                    <div>
                        <label>Contrat</label>
                        <div>
                            <label>
                                <input type="radio" name="ContratType" value="CDI" checked onchange="toggleContratDate()" />
                                CDI
                            </label>
                            <label>
                                <input type="radio" name="ContratType" value="CDD" onchange="toggleContratDate()" />
                                CDD
                            </label>
                        </div>
                        <div id="contrat-date-container" style="display: none; margin-top: 8px;">
                            <label>Date de fin de contrat</label>
                            <input type="date" name="Contrat" id="modif-contrat" />
                        </div>
                    </div>


                    <div id="btn-checkbox">
                        <div>
                            <label>
                                <input type="checkbox" name="Animateur" id="checkbox-animateur" />
                                Animateur
                            </label>
                        </div>
                        <div>
                            <label>
                                <input type="checkbox" name="Administrateur" id="checkbox-admin" />
                                Administrateur
                            </label>
                        </div>
                    </div>
                    <div>
                        <label>Service</label>
                        <select name="Service" id="modif-service" required>
                            <option value="">-- Sélectionner --</option>
                            <option value="PROD">PROD</option>
                            <option value="RD">RD</option>
                            <option value="TCS">TCS</option>
                            <option value="STC">STC</option>
                            <option value="MKT">MKT</option>
                        </select>
                    </div>
                    <div>
                        <label>Sous service</label>
                        <select name="SousService" id="modif-sous-service">
                            <option value="">-- Sélectionner --</option>
                            <option value="FAB">FAB</option>
                            <option value="LOG">LOG</option>
                            <option value="ADM">ADM</option>
                        </select>

                    </div>
                </div>
            </div>

            <div id="ctn-profil">
                <label>Profil</label>
                <div id="contenu-profil">
                    <div>
                        <img id="modif-photo" src="" alt="Photo de profil" width="80" />
                    </div>
                    <div>
                        <p>Modifier la photo de profil :</p>
                        <input type="file" name="PhotoProfil" accept="image/*" />
                        <button type="button">Image</button>
                        <button type="button">Caméra</button>
                    </div>
                </div>
            </div>

            <div class="popup-actions">
                <button type="submit">Sauvegarder</button>
                <button type="button" onclick="fermerPopupOpe()">Annuler</button>
            </div>
        </form>
    </div>



</body>

<script>
    function ouvrirPopupCreation() {
        // Vide les champs du formulaire
        document.getElementById("modif-id-operateur").value = "";
        document.getElementById("modif-nom").value = "";
        document.getElementById("modif-prenom").value = "";
        document.getElementById("modif-contrat").value = "";
        document.getElementById("modif-service").value = "";
        document.getElementById("modif-sous-service").value = "";
        document.getElementById("modif-photo").src = "@Url.Content("~/operateurs/OperateursA/default.bmp")";

        // Réinitialise les checkbox
        document.querySelectorAll('input[name="Animateur"]').forEach(c => c.checked = false);
        document.querySelectorAll('input[name="Administrateur"]').forEach(c => c.checked = false);

        // Change le titre
        document.querySelector('#popup-modifier-operateur h3').textContent = "Créer Opérateur";

        // Change l'action du formulaire
        document.getElementById("form-operateur").action = "@Url.Action("CreerOperateur", "Generique")";

        // Affiche le popup
        document.getElementById("popup-modifier-operateur").style.display = "flex";
    }

    function toggleContratDate() {
        const typeContrat = document.querySelector('input[name="ContratType"]:checked').value;
        const dateContainer = document.getElementById("contrat-date-container");

        if (typeContrat === "CDD") {
            dateContainer.style.display = "block";
        } else {
            dateContainer.style.display = "none";
            document.getElementById("modif-contrat").value = ""; // vide la date si on revient à CDI
        }
    }

    // Initialise au chargement en cas de précochage CDD
    document.addEventListener("DOMContentLoaded", toggleContratDate);

    function fermerPopupOpe() {
        const popup = document.getElementById("popup-modifier-operateur");
        popup.style.display = "none";
    }

    function ouvrirPopupModification(operateur) {
        // Remplit les champs
        document.getElementById("modif-id-operateur").value = operateur.id;
        document.getElementById("modif-nom").value = operateur.nom;
        document.getElementById("modif-prenom").value = operateur.prenom;
        document.getElementById("modif-contrat").value = operateur.contrat || "";
        document.getElementById("modif-service").value = operateur.service?.trim() || "";
        document.getElementById("modif-sous-service").value = operateur.sousService?.trim() || "";
        document.getElementById("modif-photo").src = operateur.photo;

        // Pré-cocher si animateur ou admin
        const checkboxAnimateur = document.getElementById("checkbox-animateur");
        const checkboxAdmin = document.getElementById("checkbox-admin");

        checkboxAnimateur.checked = !!operateur.animateur;
        checkboxAdmin.checked = !!operateur.isAdmin;

        if (operateur.contrat) {
            document.querySelector('input[name="ContratType"][value="CDD"]').checked = true;
            document.getElementById("modif-contrat").value = operateur.contrat.slice(0, 10);
        } else {
            document.querySelector('input[name="ContratType"][value="CDI"]').checked = true;
            document.getElementById("modif-contrat").value = "";
        }
        toggleContratDate(); // pour afficher ou masquer la date


        // Met à jour le titre et action
        document.querySelector('#popup-modifier-operateur h3').textContent = "Modifier Opérateur";
        document.getElementById("form-operateur").action = "@Url.Action("ModifierOperateur", "Generique")";

        // Affiche le popup
        document.getElementById("popup-modifier-operateur").style.display = "flex";
    }
</script>
